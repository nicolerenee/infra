---
name: Flux Local

on:
  pull_request:
    branches: ["main"]

jobs:
  filter:
    name: Flux Local - Filter
    runs-on: ubuntu-latest
    outputs:
      changed-files: ${{ steps.changed-files.outputs.changed_files }}
    steps:
      - name: Get Changed Files
        id: changed-files
        uses: bjw-s-labs/action-changed-files@1a5aeab1bfa64d0c4e786f501d5a3f1fad4a24da # v0.4.1
        with:
          patterns: |-
            .github/workflows/flux-local.yaml
            kubernetes/**/*
            apps/**/*

  clusters:
    if: ${{ needs.filter.outputs.changed-files != '[]' }}
    needs: filter
    name: Flux Local - Cluster List
    runs-on: ubuntu-latest
    outputs:
      cluster-list: ${{ steps.list.outputs.clusters }}
    steps:
      - uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - id: list
        name: Get Cluster List
        working-directory: ./kubernetes/clusters
        run: |
          echo "clusters=$(ls -d * | jq --raw-input --slurp --compact-output 'split("\n")[:-1]')" >> ${GITHUB_OUTPUT}

  test:
    if: ${{ needs.filter.outputs.changed-files != '[]' }}
    needs: [filter, clusters]
    name: Flux Local - Test
    runs-on: ubuntu-latest
    strategy:
      matrix:
        cluster: ${{ fromJSON(needs.clusters.outputs.cluster-list) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
      - name: Setup Flux CLI
        uses: fluxcd/flux2/action@b6e76ca2534f76dcb8dd94fb057cdfa923c3b641 # v2.7.3
      - uses: allenporter/flux-local/action/test@3cf5a0ae2e9bb0fb6c1f5979e34dd5f892286f64 # 8.0.1
        with:
          path: kubernetes/clusters/${{ matrix.cluster }}/flux
          enable-helm: true

  diff:
    if: ${{ needs.filter.outputs.changed-files != '[]' }}
    needs: [filter, clusters]
    name: Flux Local - Diff
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    strategy:
      matrix:
        cluster: ${{ fromJSON(needs.clusters.outputs.cluster-list) }}
      fail-fast: false
    steps:
      - name: Checkout Pull Request Branch
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          path: pull

      - name: Checkout Default Branch
        uses: actions/checkout@93cb6efe18208431cddfb8368fd83d5badbf9bfd # v5.0.1
        with:
          ref: "${{ github.event.repository.default_branch }}"
          path: default

      - name: Generate Manifests for Pull Request Branch
        uses: docker://ghcr.io/allenporter/flux-local:v8.0.0
        with:
          args: >-
            build all
            --enable-helm
            --skip-kinds VMAlert,VMRule
            --output pr.yaml
            /github/workspace/pull/kubernetes/clusters/${{ matrix.cluster }}/flux

      - name: Generate Manifests for Default Branch
        uses: docker://ghcr.io/allenporter/flux-local:v8.0.0
        with:
          args: >-
            build all
            --enable-helm
            --skip-kinds VMAlert,VMRule
            --output main.yaml
            /github/workspace/default/kubernetes/clusters/${{ matrix.cluster }}/flux

      - name: Install dyff
        uses: jaxxstorm/action-install-gh-release@6096f2a2bbfee498ced520b6922ac2c06e990ed2 # v2.1.0
        with:
          repo: homeport/dyff
          # renovate: datasource=github-releases depName=homeport/dyff
          tag: v1.10.2

      - name: Generate Diff
        id: diff
        run: |
          DYFFCMD=(
          dyff between main.yaml pr.yaml
          --ignore-order-changes
          --exclude-regexp "/metadata/labels/app.kubernetes.io/version"
          --exclude-regexp "/metadata/labels/chart"
          --exclude-regexp "/metadata/labels/helm.sh/chart"
          --exclude-regexp "/metadata/annotations/config.kubernetes.io/index"
          --exclude-regexp "/metadata/annotations/internal.config.kubernetes.io/index"
          # during local generation we generate a new ca cert everytime so ignore these fields
          --exclude-regexp "webhooks.*.victoriametrics.com.clientConfig.caBundle"
          --exclude "spec.template.metadata.annotations.checksum/secret"
          )

          summary=$("${DYFFCMD[@]}" --output brief)
          echo summary="${summary//$'\n'/ }" >> $GITHUB_OUTPUT

          # Generate full diff
          "${DYFFCMD[@]}" --output github > diff-results
          
          # Check diff size (GitHub comment limit is ~65k characters, we'll use 50k as safe limit)
          diff_size=$(wc -c < diff-results)
          echo "Diff size: $diff_size characters"
          
          if [ "$diff_size" -gt 50000 ]; then
            echo "diff_too_large=true" >> $GITHUB_OUTPUT
            echo "diff_size=$diff_size" >> $GITHUB_OUTPUT
            
            # Create truncated version for comment (first 40k chars + truncation notice)
            head -c 40000 diff-results > diff-truncated
            echo "" >> diff-truncated
            echo "" >> diff-truncated
            echo "... (diff truncated - full diff available in artifacts)" >> diff-truncated
            echo "Total diff size: $diff_size characters" >> diff-truncated
            
            # Set truncated diff for comment
            EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
            echo 'diff<<$EOF' >> $GITHUB_OUTPUT
            cat diff-truncated >> $GITHUB_OUTPUT
            echo '$EOF' >> $GITHUB_OUTPUT
          else
            echo "diff_too_large=false" >> $GITHUB_OUTPUT
            
            # Set full diff for comment
            EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
            echo 'diff<<$EOF' >> $GITHUB_OUTPUT
            cat diff-results >> $GITHUB_OUTPUT
            echo '$EOF' >> $GITHUB_OUTPUT
          fi

          # Always add to step summary (GitHub handles large summaries better)
          echo '### Diff' >> $GITHUB_STEP_SUMMARY
          echo '```diff' >> $GITHUB_STEP_SUMMARY
          if [ "$diff_size" -gt 100000 ]; then
            # Even step summary has limits, so truncate for very large diffs
            head -c 90000 diff-results >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "... (diff truncated in summary - full diff available in artifacts)" >> $GITHUB_STEP_SUMMARY
          else
            cat diff-results >> $GITHUB_STEP_SUMMARY
          fi
          echo '```' >> $GITHUB_STEP_SUMMARY
          
          # Save full diff for artifact upload
          cp diff-results "diff-${{ matrix.cluster }}.txt"

      - name: Generate Token
        uses: actions/create-github-app-token@67018539274d69449ef7c02e8e71183d1719ab42 # v2.1.4
        id: app-token
        with:
          app-id: ${{ vars.BOT_APP_ID }}
          private-key: ${{ secrets.BOT_APP_PRIVATE_KEY }}

      - if: ${{ steps.diff.outputs.diff != '' }}
        name: Upload Full Diff as Artifact
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: flux-diff-${{ matrix.cluster }}
          path: diff-${{ matrix.cluster }}.txt
          retention-days: 30

      - if: ${{ steps.diff.outputs.diff != '' && steps.diff.outputs.diff_too_large != 'true' }}
        name: Add Comment (Normal Size)
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          header: ${{ github.event.pull_request.number }}/kubernetes-dyff/${{ matrix.cluster }}
          message: |
            ### ${{ matrix.cluster }} Diff

            There were ${{ steps.diff.outputs.summary }}

            ```diff
            ${{ steps.diff.outputs.diff }}
            ```

      - if: ${{ steps.diff.outputs.diff != '' && steps.diff.outputs.diff_too_large == 'true' }}
        name: Add Comment (Large Diff)
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          header: ${{ github.event.pull_request.number }}/kubernetes-dyff/${{ matrix.cluster }}
          message: |
            ### ${{ matrix.cluster }} Diff

            There were ${{ steps.diff.outputs.summary }}

            ‚ö†Ô∏è **Large Diff Detected** (${{ steps.diff.outputs.diff_size }} characters)
            
            The diff is too large to display in a comment. You can:
            1. üì• **Download the full diff** from the [workflow artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. üìã **View in the workflow summary** (may be truncated if very large)
            3. üëÄ **Preview below** (truncated to first 40k characters)

            <details>
            <summary>üîç Click to view truncated diff preview</summary>

            ```diff
            ${{ steps.diff.outputs.diff }}
            ```

            </details>

            üí° **Tip**: Large diffs often indicate significant changes. Consider reviewing the full diff artifact for complete details.

      - if: ${{ steps.diff.outputs.diff == '' }}
        name: Add Comment
        uses: marocchino/sticky-pull-request-comment@773744901bac0e8cbb5a0dc842800d45e9b2b405 # v2.9.4
        with:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          header: ${{ github.event.pull_request.number }}/kubernetes-dyff/${{ matrix.cluster }}
          hide: true
          hide_classify: "OUTDATED"

  success:
    if: ${{ !cancelled() }}
    needs: ["diff"]
    name: Flux Local - Success
    runs-on: ubuntu-latest
    steps:
      - name: Any jobs failed?
        if: ${{ contains(needs.*.result, 'failure') }}
        run: exit 1

      - name: All jobs passed or skipped?
        if: ${{ !(contains(needs.*.result, 'failure')) }}
        run: echo "All jobs passed or skipped" && echo "${{ toJSON(needs.*.result) }}"
