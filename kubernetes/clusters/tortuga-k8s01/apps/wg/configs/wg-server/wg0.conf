[Interface]
Address = 10.66.0.1/24, fd66::1/112
ListenPort = 51820
PrivateKey = {{ .private_key }}
MTU = 1370

# Forwarding rules for VPN traffic
PostUp = iptables -C FORWARD -i %i -j ACCEPT 2>/dev/null || iptables -A FORWARD -i %i -j ACCEPT
PostUp = iptables -C FORWARD -o %i -j ACCEPT 2>/dev/null || iptables -A FORWARD -o %i -j ACCEPT
PostUp = ip6tables -C FORWARD -i %i -j ACCEPT 2>/dev/null || ip6tables -A FORWARD -i %i -j ACCEPT
PostUp = ip6tables -C FORWARD -o %i -j ACCEPT 2>/dev/null || ip6tables -A FORWARD -o %i -j ACCEPT

# NAT for VPN client traffic going to internet (masquerade via pod's eth0)
PostUp = iptables -t nat -A POSTROUTING -s 10.66.0.0/24 -o eth0 -j MASQUERADE
PostUp = ip6tables -t nat -A POSTROUTING -s fd66::/112 -o eth0 -j MASQUERADE

# Port forwarding for qBittorrent (10.66.0.10 / fd66::10)
PostUp = iptables -t nat -A PREROUTING -p tcp --dport 50469 -j DNAT --to-destination 10.66.0.10:50469
PostUp = iptables -t nat -A PREROUTING -p udp --dport 50469 -j DNAT --to-destination 10.66.0.10:50469
PostUp = ip6tables -t nat -A PREROUTING -p tcp --dport 50469 -j DNAT --to-destination [fd66::10]:50469
PostUp = ip6tables -t nat -A PREROUTING -p udp --dport 50469 -j DNAT --to-destination [fd66::10]:50469

# Cleanup
PostDown = iptables -D FORWARD -i %i -j ACCEPT || true
PostDown = iptables -D FORWARD -o %i -j ACCEPT || true
PostDown = ip6tables -D FORWARD -i %i -j ACCEPT || true
PostDown = ip6tables -D FORWARD -o %i -j ACCEPT || true
PostDown = iptables -t nat -D POSTROUTING -s 10.66.0.0/24 -o eth0 -j MASQUERADE || true
PostDown = ip6tables -t nat -D POSTROUTING -s fd66::/112 -o eth0 -j MASQUERADE || true
PostDown = iptables -t nat -D PREROUTING -p tcp --dport 50469 -j DNAT --to-destination 10.66.0.10:50469 || true
PostDown = iptables -t nat -D PREROUTING -p udp --dport 50469 -j DNAT --to-destination 10.66.0.10:50469 || true
PostDown = ip6tables -t nat -D PREROUTING -p tcp --dport 50469 -j DNAT --to-destination [fd66::10]:50469 || true
PostDown = ip6tables -t nat -D PREROUTING -p udp --dport 50469 -j DNAT --to-destination [fd66::10]:50469 || true

[Peer]
# qbittorrent-vpn - atlantis cluster
PublicKey = {{ .peer_qbittorrent_pubkey }}
PresharedKey = {{ .peer_qbittorrent_psk }}
AllowedIPs = 10.66.0.10/32, fd66::10/128
