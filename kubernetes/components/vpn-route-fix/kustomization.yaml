---
# yaml-language-server: $schema=https://www.schemastore.org/kustomization.json
apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component
#
# Usage:
# 1. Add label to your Flux Kustomization: infra.freckle.systems/vpn-route-fix: enabled
# 2. Set these variables in postBuild.substitute:
#    - CONTROLLER_NAME: the controller name in the HelmRelease (e.g., qbittorrent)
#    - VPN_IP: the IP address for the VPN interface (e.g., 192.168.66.10/25)
#    - VPN_MAC: the MAC address for the VPN interface
#
patches:
  - target:
      kind: Kustomization
      labelSelector: infra.freckle.systems/vpn-route-fix=enabled
    patch: |
      apiVersion: kustomize.toolkit.fluxcd.io/v1
      kind: Kustomization
      metadata:
        name: all
      spec:
        patches:
          - target:
              kind: HelmRelease
            patch: |-
              - op: add
                path: /spec/values/controllers/${CONTROLLER_NAME}/initContainers
                value:
                  route-fix:
                    image:
                      repository: alpine
                      tag: latest
                    securityContext:
                      capabilities:
                        add:
                          - NET_ADMIN
                    command:
                      - /bin/sh
                      - -c
                      - |
                        set -e
                        apk add --no-cache iproute2

                        ETH0_GW=$(ip route show dev eth0 | grep "scope link" | head -1 | awk '{print $1}')
                        ETH0_GW6=$(ip -6 route show dev eth0 | grep "^fe80::" | head -1 | awk '{print $1}')

                        echo "eth0 IPv4 gateway: $ETH0_GW"
                        echo "eth0 IPv6 gateway: $ETH0_GW6"

                        ip route del default via $ETH0_GW dev eth0 || true
                        ip route add ${CLUSTER_POD_CIDR} via $ETH0_GW dev eth0
                        ip route add ${CLUSTER_SVC_CIDR} via $ETH0_GW dev eth0

                        if [ -n "$ETH0_GW6" ]; then
                          ip -6 route del default via $ETH0_GW6 dev eth0 || true
                          ip -6 route add ${CLUSTER_POD_CIDR_V6} via $ETH0_GW6 dev eth0
                          ip -6 route add ${CLUSTER_SVC_CIDR_V6} via $ETH0_GW6 dev eth0
                        fi

                        echo "Routes configured:"
                        ip route
                        ip -6 route
